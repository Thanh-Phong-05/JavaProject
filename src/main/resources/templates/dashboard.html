<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security6">
<head>
    <meta charset="UTF-8">
    <title>Bảng điều khiển EV Owner</title>
    <th:block th:insert="~{fragments :: head}" />
</head>
<body>

    <div th:replace="~{fragments :: navbar}"></div>

    <div class="container mt-4">
        <div th:if="${message}"
             th:class="${#strings.contains(message, 'Lỗi') ? 'alert alert-danger' : 'alert alert-success'}"
             th:text="${message}">
        </div>

        <h1 class="mb-3">Xin chào, <span sec:authentication="name">Tên Người Dùng</span>!</h1>
        <p>Chào mừng bạn trở lại bảng điều khiển quản lý tín chỉ Carbon.</p>

        <div class="row">
            <div class="col-md-7">
                <div class="card card-body mb-3">
                    <h5 class="card-title">Đồng bộ hành trình (Upload CSV)</h5>
                    <form method="POST" th:action="@{/trips/upload}" enctype="multipart/form-data">
                        <div class="input-group">
                            <input type="file" name="file" class="form-control" id="fileUpload" accept=".csv" required>
                            <button type="submit" class="btn btn-primary">Tải lên</button>
                        </div>
                        <small class="text-muted">Hệ thống sẽ tự động tính toán và tạo tín chỉ thô.</small>
                    </form>
                </div>

                <div class="card card-body mb-3">
                    <h5 class="card-title">Niêm yết Tín chỉ để bán</h5>
                    <form method="POST" th:action="@{/listings/create}">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label for="quantity" class="form-label">Số lượng bán:</label>
                                <input type="number" step="0.01" name="quantity" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label for="price" class="form-label">Giá (VND/tín chỉ):</label>
                                <input type="number" step="1000" name="price" class="form-control" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success mt-3 w-100">Đăng bán lên sàn</button>
                    </form>
                </div>
            </div>

            <div class="col-md-5">
                <div class="card card-body mb-3 bg-light border-success" th:if="${owner}">
                    <h4 class="text-success">Ví của bạn</h4>
                    <hr>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Số dư Tín chỉ:</span>
                        <strong th:text="${#numbers.formatDecimal(owner.wallet.creditBalance, 1, 2) + ' CC'}">0.00 CC</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Số dư Tiền mặt:</span>
                        <strong th:text="${#numbers.formatCurrency(owner.wallet.cashBalance)}">0 VND</strong>
                    </div>
                    <form th:action="@{/wallet/withdraw}" method="POST" class="mt-3 text-end">
                        <button type="submit" class="btn btn-sm btn-outline-danger" 
                                onclick="return confirm('Bạn có chắc muốn rút toàn bộ tiền về ngân hàng?')">
                            <i class="bi bi-cash-coin"></i> Rút tiền về Ngân hàng
                        </button>
                    </form>
                </div>

                <div class="card card-body mb-3">
                    <h5>Báo cáo hiệu quả</h5>
                    <p class="mb-1">Tổng quãng đường: <strong th:text="${#numbers.formatDecimal(totalDistance, 1, 1)}">0</strong> km</p>
                    <p class="mb-0">Tổng CO2 giảm thải: <strong th:text="${#numbers.formatDecimal(totalCO2Saved, 1, 2)}">0</strong> kg</p>
                </div>
            </div>
        </div> 

        <h3 class="mt-4">Quản lý Tín chỉ Carbon</h3>
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Số lượng (tấn)</th>
                        <th>Ngày tạo</th>
                        <th>Trạng thái / Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="credit : ${credits}">
                        <td th:text="${credit.id}">1</td>
                        <td th:text="${#numbers.formatDecimal(credit.quantity, 1, 2)}">5.2</td>
                        <td th:text="${credit.issuedAt}">2025-01-01</td>
                        <td>
                            <span th:if="${credit.verified}" class="badge bg-success rounded-pill">
                                <i class="bi bi-check-circle"></i> Đã xác minh
                            </span>

                            <div th:unless="${credit.verified}">
                                <span class="badge bg-warning text-dark mb-2">Chưa xác minh</span>
                                
                                <form th:action="@{/owner/credits/{id}/request-issue(id=${credit.id})}" method="POST" class="d-flex gap-2">
                                    <input type="text" name="note" class="form-control form-control-sm" placeholder="Ghi chú cho CVA..." required>
                                    <button type="submit" class="btn btn-sm btn-outline-primary text-nowrap">
                                        Gửi yêu cầu kiểm định
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${credits.isEmpty()}">
                        <td colspan="4" class="text-center text-muted py-3">Bạn chưa có tín chỉ nào. Hãy upload hành trình để tạo tín chỉ.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h3 class="mt-4">Lịch sử hành trình</h3>
        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead>
                    <tr>
                        <th>Mã chuyến</th>
                        <th>Ngày đi</th>
                        <th>Quãng đường (km)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="trip : ${trips}">
                        <td th:text="${trip.id}">101</td>
                        <td th:text="${trip.date}">2025-01-05</td>
                        <td th:text="${trip.distanceKm}">150.5</td>
                    </tr>
                    <tr th:if="${trips.isEmpty()}">
                        <td colspan="3" class="text-center text-muted">Chưa có dữ liệu.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h3 class="mt-4">Lịch sử Bán Tín chỉ</h3>
        <div class="table-responsive mb-5">
            <table class="table table-striped table-hover table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Mã GD</th>
                        <th>Ngày giao dịch</th>
                        <th>Số lượng (tấn)</th>
                        <th>Tổng thu (VND)</th>
                        <th>Trạng thái</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="tx : ${transactions}">
                        <td th:text="${'TX-' + tx.id}">TX-101</td>
                        <td th:text="${#temporals.format(tx.createdAt, 'dd-MM-yyyy HH:mm')}">01-01-2025</td>
                        <td th:text="${tx.quantity}">10.0</td>
                        <td th:text="${#numbers.formatCurrency(tx.totalPrice)}" class="text-success fw-bold">1,000,000</td>
                        <td>
                            <span class="badge bg-success">HOÀN TẤT</span>
                        </td>
                    </tr>
                    <tr th:if="${transactions == null or transactions.isEmpty()}">
                        <td colspan="5" class="text-center text-muted">Chưa có giao dịch bán nào.</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

    <div th:replace="~{fragments :: footer-scripts}"></div>
</body>
</html>