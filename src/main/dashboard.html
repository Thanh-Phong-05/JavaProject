<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <!-- Optional: Bootstrap để giao diện dễ nhìn (có thể bỏ nếu không dùng) -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
</head>
<body class="container py-4">

  <header class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="m-0">Dashboard - <span th:text="${me.username}">user</span></h2>
    <nav class="d-flex gap-2">
      <a class="btn btn-outline-primary btn-sm" th:href="@{/marketplace}">Marketplace</a>
      <a class="btn btn-outline-secondary btn-sm" th:href="@{/logout}">Logout</a>
    </nav>
  </header>

  <section class="mb-4">
    <div class="alert alert-info mb-2">
      Cash: <strong th:text="${me.cashBalance}">0</strong> |
      Credits: <strong th:text="${me.creditBalance}">0</strong>
    </div>
  </section>

  <!-- Tạo credit từ tổng km (demo hiện có) -->
  <section class="mb-4">
    <h4>Create credit from total km (demo)</h4>
    <form th:action="@{/uploadKm}" method="post" class="row g-2 align-items-end">
      <div class="col-auto">
        <label class="form-label mb-0">Total km</label>
        <input class="form-control" name="km" type="number" step="0.1" required/>
      </div>
      <div class="col-auto">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button type="submit" class="btn btn-primary">Create Credit</button>
      </div>
    </form>
  </section>

  <!-- Upload trips CSV + tạo credit từ trips -->
  <section class="mb-4">
    <h4>Trips → Carbon Credit</h4>
    <div class="row g-2">
      <div class="col-12 col-md-6">
        <form th:action="@{/uploadTripsCsv}" method="post" enctype="multipart/form-data" class="border p-3 rounded">
          <label class="form-label">Upload trips CSV</label>
          <input class="form-control mb-2" type="file" name="file" accept=".csv" required/>
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          <button type="submit" class="btn btn-success">Upload & Save Trips</button>
          <div class="form-text mt-2">
            Hỗ trợ: <code>date,distance,energy</code> hoặc <code>distance,energy,date</code> (YYYY-MM-DD).
          </div>
        </form>
      </div>
      <div class="col-12 col-md-6">
        <form th:action="@{/createCreditFromTrips}" method="post" class="border p-3 rounded">
          <label class="form-label">Tạo tín chỉ từ tất cả trips đã lưu</label><br/>
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          <button type="submit" class="btn btn-warning">Create Credit From Trips</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Danh sách tín chỉ của tôi -->
  <section class="mb-4">
    <h4>Your Credits</h4>
    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Qty (tCO₂e)</th>
            <th>Verified</th>
            <th style="width: 1%;">Actions</th>
          </tr>
        </thead>
        <tbody>
        <tr th:each="c : ${credits}">
          <td th:text="${c.id}">1</td>
          <td th:text="${c.quantity}">0.02</td>
          <td>
            <span class="badge" th:classappend="${c.verified} ? 'bg-success' : 'bg-secondary'"
                  th:text="${c.verified} ? 'Verified' : 'Draft'">Draft</span>
          </td>
          <td>
            <!-- Verify (CVA) -->
            <form th:action="@{/verifyCredit}" method="post" class="d-inline">
              <input type="hidden" name="creditId" th:value="${c.id}"/>
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <button class="btn btn-outline-success btn-sm" type="submit"
                      th:disabled="${c.verified}">Verify</button>
            </form>

            <!-- Create Listing -->
            <form th:action="@{/createListing}" method="post" class="d-inline ms-2">
              <input type="hidden" name="creditId" th:value="${c.id}"/>
              <input class="form-control form-control-sm d-inline-block" style="width: 8rem;"
                     name="qty" type="number" step="0.0001" placeholder="qty" required/>
              <input class="form-control form-control-sm d-inline-block" style="width: 8rem;"
                     name="price" type="number" step="0.01" placeholder="price" required/>
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <button class="btn btn-primary btn-sm" type="submit" th:disabled="${!c.verified}">Create Listing</button>
            </form>
          </td>
        </tr>
        <tr th:if="${credits == null or #lists.isEmpty(credits)}">
          <td colspan="4" class="text-center text-muted">No credits yet</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- My Active Listings: cho phép hủy -->
  <section>
    <h4>My Active Listings</h4>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Qty</th>
            <th>Price/credit</th>
            <th>Status</th>
            <th style="width: 1%;">Action</th>
          </tr>
        </thead>
        <tbody>
        <tr th:each="l : ${listings}">
          <td th:text="${l.id}">10</td>
          <td th:text="${l.quantity}">0.10</td>
          <td th:text="${l.pricePerCredit}">12.50</td>
          <td>
            <span class="badge bg-success" th:if="${l.active}">Active</span>
            <span class="badge bg-secondary" th:unless="${l.active}">Closed</span>
          </td>
          <td>
            <form th:if="${l.active}" th:action="@{/marketplace/cancel}" method="post" class="d-inline">
              <input type="hidden" name="listingId" th:value="${l.id}"/>
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <button class="btn btn-danger btn-sm" type="submit">Cancel</button>
            </form>
          </td>
        </tr>
        <tr th:if="${listings == null or #lists.isEmpty(listings)}">
          <td colspan="5" class="text-center text-muted">No active listings</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Optional: Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
